Function.prototype.bind||(Function.prototype.bind=function(e){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var t=Array.prototype.slice.call(arguments,1),n=this,i=function(){},o=function(){return n.apply(this instanceof i?this:e||window,t.concat(Array.prototype.slice.call(arguments)))};return i.prototype=this.prototype,o.prototype=new i,o});var Spacebrew=Spacebrew||{},WebSocket=WebSocket||{},window=window||void 0,module=module||void 0;window&&(window.getQueryString||(window.getQueryString=function(e){if(window.location){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(window.location.href);return null==t?"":t[1]}})),!window&&module&&(WebSocket=require("ws"),module.exports={Spacebrew:Spacebrew}),Spacebrew.Client=function(e,t,n,i){if(i=i||{},void 0!==e&&"[object String]"!==toString.call(e)&&(i.port=e.port||void 0,i.debug=e.debug||!1,i.reconnect=e.reconnect||!1,n=e.description||void 0,t=e.name||void 0,e=e.server||void 0),this.debug=!1,window&&(this.debug="true"===window.getQueryString("debug")||(i.debug||!1)),this.reconnect="boolean"!=typeof i.reconnect||i.reconnect,this.reconnect_timer=void 0,this.sendRateCapped=void 0!==i.capSendRate&&i.capSendRate,this.send_interval=i.sendRate||16,this.send_blocked=!1,this.msg={},this._name=t||"javascript client #",window&&(this._name=""!==window.getQueryString("name")?unescape(window.getQueryString("name")):this._name),this._description=n||"spacebrew javascript client",window&&(this._description=""!==window.getQueryString("description")?unescape(window.getQueryString("description")):this._description),this.server=e||"sandbox.spacebrew.cc",window&&(this.server=""!==window.getQueryString("server")?unescape(window.getQueryString("server")):this.server),this.port=i.port||9e3,window){var o=window.getQueryString("port");""===o||isNaN(o)||(this.port=o)}this.socket=null,this.client_config={name:this._name,description:this._description,publish:{messages:[]},subscribe:{messages:[]},options:{}},this.admin={},this._isConnected=!1},Spacebrew.Client.prototype.connect=function(){try{this.socket=new WebSocket("ws://"+this.server+":"+this.port),this.socket.binaryType="arraybuffer",this.socket.onopen=this._onOpen.bind(this),this.socket.onmessage=this._onMessage.bind(this),this.socket.onclose=this._onClose.bind(this),this.socket.onerror=this._onError.bind(this)}catch(e){this._isConnected=!1,console.log("[connect:Spacebrew] connection attempt failed")}},Spacebrew.Client.prototype.close=function(){try{this._isConnected&&(this.socket.close(),this._isConnected=!1,console.log("[close:Spacebrew] closing websocket connection"))}catch(e){this._isConnected=!1}},Spacebrew.Client.prototype.onOpen=function(e,t){},Spacebrew.Client.prototype.onClose=function(e,t){},Spacebrew.Client.prototype.onError=function(e,t){},Spacebrew.Client.prototype.onRangeMessage=function(e,t){},Spacebrew.Client.prototype.onBooleanMessage=function(e,t){},Spacebrew.Client.prototype.onStringMessage=function(e,t){},Spacebrew.Client.prototype.onCustomMessage=function(e,t,n){},Spacebrew.Client.prototype.onBinaryMessage=function(e,t,n){},Spacebrew.Client.prototype.addPublish=function(e,t,n){this.client_config.publish.messages.push({name:e,type:t,default:n}),this.updatePubSub()},Spacebrew.Client.prototype.addSubscribe=function(e,t){this.client_config.subscribe.messages.push({name:e,type:t}),this.updatePubSub()},Spacebrew.Client.prototype.updatePubSub=function(){this._isConnected&&this.socket.send(JSON.stringify({config:this.client_config}))},Spacebrew.Client.prototype.send=function(e,t,n){var i=this;switch(this.msg={message:{clientName:this._name,name:e,type:t}},typeof n){case"undefined":return void console.warn("provided 'value' is undefined, not sending");case"string":case"boolean":case"number":this.msg.message.value=n;break;default:"buffer"in n&&n.buffer instanceof ArrayBuffer&&(n=n.buffer),n instanceof ArrayBuffer?this.msg.message.value=n.byteLength:(console.log("'value' of type",typeof n,"unexpected, sending and hoping for the best"),this.msg.message.value=n)}if(this.sendRateCapped)this.send_blocked||(this.socket.send(JSON.stringify(this.msg)),this.send_blocked=!0,this.msg=void 0,setTimeout((function(){i.send_blocked=!1,void 0!==i.msg&&i.send(i.msg.message.name,i.msg.message.type,i.msg.message.value)}),i.send_interval));else if(n instanceof ArrayBuffer){var o=JSON.stringify(this.msg),r=Spacebrew.numBytesToEncodeString(o),s=r<254?1:r<=65535?3:5,c=n.byteLength+r+s,a=new ArrayBuffer(c),p=new Uint8Array(a,0,s);5==s?(p[0]=255,p[1]=r>>>24&255,p[2]=r>>>16&255,p[3]=r>>>8&255,p[4]=255&r):3==s?(p[0]=254,p[1]=r>>>8&255,p[2]=255&r):p[0]=r,Spacebrew.encodeToBuffer(o,new Uint8Array(a,s,r)),new Uint8Array(a,s+r).set(new Uint8Array(n)),this.socket.send(a)}else this.socket.send(JSON.stringify(this.msg))},Spacebrew.Client.prototype._onOpen=function(){console.log("[_onOpen:Spacebrew] Spacebrew connection opened, client name is: "+this._name),this._isConnected=!0,this.admin.active&&this.connectAdmin(),this.reconnect_timer&&(console.log("[_onOpen:Spacebrew] tearing down reconnect timer"),this.reconnect_timer=clearInterval(this.reconnect_timer),this.reconnect_timer=void 0),this.updatePubSub(),this.onOpen()},Spacebrew.Client.prototype._onMessage=function(e){var t,n,i,o,r;if(e.data instanceof ArrayBuffer){var s=new Uint8Array(e.data),c=s[0],a=1;if(254==c?(c=(s[1]<<8)+s[2],a=3):255==c&&(c=(s[1]<<24)+(s[2]<<16)+(s[3]<<8)+s[4],a=5),!(c>0))return;try{var p=Spacebrew.decodeFromBuffer(new Uint8Array(e.data,a,c));t=JSON.parse(p),n={buffer:e.data,startIndex:a+c}}catch(e){return void console.error(e)}}else t=JSON.parse(e.data);if(("targetType"in t||t instanceof Array)&&"client"!=t.targetType)this.admin&&this._handleAdminMessages(t);else{if(!("message"in t))return;if(i=t.message.name,o=t.message.type,r=t.message.value,t.message.clientName&&t.message.clientName,void 0!==n)this.onBinaryMessage(i,n,o);else switch(o){case"boolean":this.onBooleanMessage(i,"true"==r);break;case"string":this.onStringMessage(i,r);break;case"range":this.onRangeMessage(i,Number(r));break;default:this.onCustomMessage(i,r,o)}}},Spacebrew.Client.prototype._onClose=function(){var e=this;console.log("[_onClose:Spacebrew] Spacebrew connection closed"),this._isConnected=!1,this.admin.active&&(this.admin.remoteAddress=void 0),this.reconnect&&!this.reconnect_timer&&(console.log("[_onClose:Spacebrew] setting up reconnect timer"),this.reconnect_timer=setInterval((function(){!1!==e.isConnected&&(e.connect(),console.log("[reconnect:Spacebrew] attempting to reconnect to spacebrew"))}),5e3)),this.onClose()},Spacebrew.Client.prototype._onError=function(e){var t=this;console.log("[_onError:Spacebrew] Spacebrew connection error"),this._isConnected=!1,this.admin.active&&(this.admin.remoteAddress=void 0),this.reconnect&&!this.reconnect_timer&&(console.log("[_onError:Spacebrew] setting up reconnect timer"),this.reconnect_timer=setInterval((function(){!1!==t.isConnected&&(t.connect(),console.log("[reconnect:Spacebrew] attempting to reconnect to spacebrew"))}),5e3)),this.onError(e)},Spacebrew.Client.prototype.name=function(e){if(e){if(this._isConnected)return!1;this._name=e,window&&(this._name=""!==window.getQueryString("name")?unescape(window.getQueryString("name")):this._name),this.client_config.name=this._name}return this._name},Spacebrew.Client.prototype.description=function(e){if(e){if(this._isConnected)return!1;this._description=e||"spacebrew javascript client",window&&(this._description=""!==window.getQueryString("description")?unescape(window.getQueryString("description")):this._description),this.client_config.description=this._description}return this._description},Spacebrew.Client.prototype.isConnected=function(){return this._isConnected},Spacebrew.Client.prototype.extend=function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t])},Spacebrew.numBytesToEncodeString=function(e){for(var t=0,n=e.length-1;n>=0;n--)t+=Spacebrew.numBytesToEncodeCode(e.charCodeAt(n));return t},Spacebrew.numBytesToEncodeCode=function(e){return e>>16>0?4:e>>11>0?3:e>>7>0?2:1},Spacebrew.encodeToBuffer=function(e,t){if(!(t instanceof Uint8Array)){var n=new ArrayBuffer(Spacebrew.numBytesToEncodeString(e));t=new Uint8Array(n)}for(var i,o,r=0,s=0;s<e.length;s++)if(o=e.charCodeAt(s),1==(i=Spacebrew.numBytesToEncodeCode(o)))t[r]=o,r++;else{for(var c=128,a=1;a<i;a++)c=c>>1|128,t[r+i-a]=128|63&o,o>>>=6;t[r]=c|o,r+=i}return t},Spacebrew.decodeFromBuffer=function(e){if(e instanceof Uint8Array){for(var t,n,i,o="",r=0;r<e.length;){for(i=e[r],r++,n=0;(128&i)>0;)n++,i=i<<1&255;t=i>>>n,0===n&&(n=1);for(var s=1;s<n;s++)t=t<<6|63&e[r],r++;o+=String.fromCharCode(t)}return o}};